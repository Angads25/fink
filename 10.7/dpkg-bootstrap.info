Package: dpkg-bootstrap
Version: 1.17.6
Revision: 1
GCC: 4.0
Maintainer: Fink Core Group <fink-core@lists.sourceforge.net>

Source: mirror:sourceforge:fink/dpkg_%v.tar.gz
SourceDirectory: dpkg-%v
Source-MD5: bdb6d88470c901d35fa19d776a8e8828

PatchFile: dpkg.patch
PatchFile-MD5: d8511df8f2a98c08c752cc1ce1dfc305

PatchScript: <<
sed -e 's,@FINKPREFIX@,%p,g' %{PatchFile} | patch -p1

patch -p1 < fink/patches/add-BOD.patch
patch -p1 < fink/patches/build-fix.patch
patch -p1 < fink/patches/c++filt-defaults.patch
patch -p1 < fink/patches/dselect-methods.patch
patch -p1 < fink/patches/fink-virtuals.patch
patch -p1 < fink/patches/full-path-calls.patch
patch -p1 < fink/patches/gzip-rsyncable-fix.patch
patch -p1 < fink/patches/location-fixes.patch
patch -p1 < fink/patches/protect-system-dirs.patch
patch -p1 < fink/patches/so-to-dylib.patch
patch -p1 < fink/patches/test-fix.patch
patch -p1 < fink/patches/fink-as-vendor.patch
patch -p1 < fink/patches/add-install-info.patch

# Remove po4a and make sure it can't be found if it's installed
# this is to keep fink policy happy since it has to build the same
# everytime on all systems
perl -pi -e 's,po4a,notpo4a,g' configure

# Make sure all scripts have use lib %p/lib/perl5 to find the modules it needs
perl -pi -e 's,^(\#\!/usr/bin/perl.*)$,$1\nuse lib "%p/lib/perl5";,' %b/scripts/*.pl

# fix paths
for i in %b/po/*.po %b/po/*.pot %b/doc/triggers.txt %b/man/*.[13578] %b/man/*/*.[13578]; do \
  perl -pi -e 's,/usr,%p,g' $i; \
  perl -pi -e 's,/var,%p/var,g' $i; \
  perl -pi -e 's,/etc,%p/etc,g' $i; \
  perl -pi -e 's,amd64,x86_64,g' $i; \
done 

cp scripts/t/200_Dpkg_Shlibs/objdump.basictags-amd64 scripts/t/200_Dpkg_Shlibs/objdump.basictags-x86_64

# Fink uses "x86_64" instead of "amd64"
perl -pi -e 's,amd64,x86_64,g' *table scripts/Makefile.in scripts/Makefile.am scripts/t/200_Dpkg_Shlibs/basictags.c scripts/t/200_Dpkg_Shlibs/basictags.symbols scripts/t/200_Dpkg_Shlibs/objdump.basictags-x86_64 scripts/t/200_Dpkg_Shlibs.t

# Fix for tar (Slightly modified for dpkg-bootstrap)
if [ "%n" = "dpkg-bootstrap" ]; then \
  if [[ $(/usr/bin/sw_vers -productVersion) > 10.8 ]]; then \
    perl -pi -e 's,\"tar\",\"/usr/bin/tar\",g' dpkg-deb/build.c dpkg-deb/extract.c lib/dpkg/dpkg.h lib/dpkg/subproc.c; \
    perl -pi -e 's,--warning=no-timestamp,-v,g' dpkg-deb/extract.c; \
    perl -pi -e 's,--format=gnu,--format=ustar,g' dpkg-deb/build.c; \
  else \
    perl -pi -e 's,\"tar\",\"/usr/bin/gnutar\",g' dpkg-deb/build.c dpkg-deb/extract.c lib/dpkg/dpkg.h lib/dpkg/subproc.c; \
    perl -pi -e 's,--warning=no-timestamp,--format=gnu,g' dpkg-deb/extract.c; \
  fi \
else \
  perl -pi -e 's,\"tar\",\"%p/bin/gnutar\",g' dpkg-deb/build.c dpkg-deb/extract.c lib/dpkg/dpkg.h lib/dpkg/subproc.c; \
fi

# Fix gnu date -R for BSD date +"%a, %d %b %Y %H:%M:%S %z"
perl -pi -e "s;date -R;date +'%%a, %%d %%b %%Y %%H:%%M:%%S %%z';g" scripts/dpkg-genchanges.pl

# Fix for older gcc ie: 10.5
perl -pi -e 's,-Wvla ,,g' configure

# Move dselect and dpkg-dev locals for cleaner Install Phases
perl -pi -e 's,localedir = \$\(datadir\)\/locale,localedir = \$(datadir)/locale-dselect,g' dselect/Makefile.in
perl -pi -e 's,localedir = \@localedir\@,localedir = \@localedir\@-dselect,g' dselect/po/Makefile.in.in
perl -pi -e 's,localedir = \@localedir\@,localedir = \@localedir\@-perl,g' scripts/Makefile.in scripts/po/Makefile.in.in
<<

SetCFLAGS: -g -O2 -fstack-protector -Wformat -fPIE -F/System/Library/Frameworks/CoreFoundation.framework -Wno-unused-parameter -Wno-missing-field-initializers -Wno-cast-align -Wno-format-security
SetCPPFLAGS: -D_FORTIFY_SOURCE=2
SetCXXFLAGS: -g -O2 -fstack-protector -Wformat -fPIE
SetLDFLAGS: -Wl,-read_only_stubs -Wl,-bind_at_load -fPIE -Wl,-pie -framework CoreFoundation

# Use %P for all state and admindirs for pre fink build
ConfigureParams: <<
  --disable-dselect \
  --disable-start-stop-daemon \
  --with-admindir=%P/var/lib/dpkg \
  --mandir=%p/share/man \
  --infodir=%p/share/info \
  --sysconfdir=%p/etc \
  --sbindir=%p/sbin \
  --localstatedir=%P/var \
  --with-zlib \
  --without-liblzma \
  --with-bz2 \
  --srcdir=%b \
  --build=%m-apple-darwin \
  --disable-linker-optimisations \
  --with-dpkg-deb-compressor=gzip \
  PERL_LIBDIR=%p/lib/perl5 \
  PERL=/usr/bin/perl
<<

InfoTest: <<
  TestConfigureParams: <<
    --disable-silent-rules
  <<
  TestDepends: <<
    io-string-pm,
    time-date-pm,
    objtools,
    sensible-utils
  <<
  TestScript: <<
    make check || exit 2
  <<
<<

InstallScript: <<
  install -d -m 0755 %i/share/doc/dpkg

  make install DESTDIR=%d

  install -d -m 0755 %i/etc/dpkg/origins
  install -c -p -m 644 fink/origins %i/etc/dpkg/origins/fink
  install -c -p -m 644 debian/dselect.cfg %i/etc/dpkg
  ## currently in fink
  # install -c -p -m 644 debian/shlibs.default %i/etc/dpkg
  install -c -p -m 644 debian/shlibs.override %i/etc/dpkg
  install -c -p -m 644 fink/buildflags.conf %i/etc/dpkg
  rm -rf %i/lib/dpkg/methods/*

  install -m 0755 fink/md5sum %i/bin

  install -d -m 0755 %i/etc/cron.daily
  install -d -m 0755 %i/var/backups
  install -m 0644 fink/dpkg.cron.daily %i/etc/cron.daily/dpkg

  # install fink as a vendor
  install -m 0644 scripts/Dpkg/Vendor/Fink.pm %i/lib/perl5/Dpkg/Vendor/Fink.pm
<<
ConfFiles: <<
  %p/etc/dpkg/origins/fink
<<
DocFiles: <<
  ABOUT-NLS AUTHORS COPYING ChangeLog NEWS
  README* THANKS TODO
<<
Description: The Debian package manager (bootstrap package)
DescDetail: <<
This package provides the low-level infrastructure for handling the
installation and removal of Debian software packages.
.
For Debian package development tools, install dpkg-dev.
<<
DescPort: <<
See dpkg DescPort
<<
License: GPL
Homepage: https://wiki.debian.org/Teams/Dpkg
